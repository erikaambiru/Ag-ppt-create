# 品質ガイドライン

## 出典表記ルール（★ 重要）

既存の PPTX から新規 PPTX を生成する場合、**スピーカーノートに元スライド番号を記載**。

### 自動追加（reconstruct 方式）

`reconstruct_analyzer.py` が各スライドのノートに自動追加：

```
[出典: 元スライド #5]
```

### 手動作成・統合時のルール

| ケース                       | ノートに記載する内容                   |
| ---------------------------- | -------------------------------------- |
| 1 対 1 変換                  | `[出典: 元スライド #N]`                |
| 複数スライド統合             | `[出典: 元スライド #3, #4, #5]`        |
| 要約・再構成                 | `[出典: 元スライド #10-15 を基に要約]` |
| 新規追加（元にないスライド） | `[新規作成]`                           |

### 例（統合スライド）

```json
{
  "type": "content",
  "title": "Azure の主要サービス",
  "items": [
    { "text": "Compute: VM, AKS, Functions" },
    { "text": "Storage: Blob, Files, Queue" },
    { "text": "Database: SQL, Cosmos DB" }
  ],
  "notes": "元の3つのスライドを1つに統合しました。\n\n---\n[出典: 元スライド #8, #9, #10 を統合]"
}
```

## スライド構成ルール

1. **アジェンダ必須**: タイトルスライドの直後に必ず `type: "agenda"` を配置
2. **まとめ必須**: クロージング前に必ず Summary/まとめスライドを配置
3. **空スライド禁止**: スピーカーノートだけのスライド（本文なし）は生成しない
4. **最小コンテンツ**: `type: "content"` には必ず `items` または `bullets` が必要
5. **セクションスライドにはサブタイトル必須**: `type: "section"` には必ず `subtitle` を追加（空っぽに見える問題を防止）
6. **スピーカーノートの充実**: 全スライドのノートには具体的な説明を記載（出典だけでは不十分）

### ⚠️ セクションスライドのルール（★ 重要）

**問題**: `type: "section"` でタイトルのみだと「空っぽに見える」

**推奨**: 必ず `subtitle` フィールドでセクションの概要を追加

```json
// ❌ NG: タイトルのみで空っぽに見える
{
  "type": "section",
  "title": "MCP サーバーの開発とデプロイ"
}

// ✅ OK: サブタイトルで概要を追加
{
  "type": "section",
  "title": "MCP サーバーの開発とデプロイ",
  "subtitle": "VS Code で開発し Azure Container App にデプロイ"
}
```

### ⚠️ title と subtitle が重なる問題

一部のテンプレート（特に Microsoft Ignite 等のイベント用）では、Section Title レイアウトの TITLE と SUBTITLE プレースホルダーが同じ位置に配置されていることがあります。

**症状**: タイトルとサブタイトルのテキストが重なって表示される（二重に見える）

**回避策**:

1. **subtitle を使わず、title に統合**:

   ```json
   {
     "type": "section",
     "title": "データセキュリティリーダーの優先事項",
     "notes": "AI時代に求められる統合データセキュリティについて説明します。"
   }
   ```

2. **subtitle を短くしてノートに詳細を移動**:
   ```json
   {
     "type": "section",
     "title": "AI時代のデータセキュリティ",
     "subtitle": "（次のトピック）",
     "notes": "詳細な説明はノートに記載..."
   }
   ```

### セクションスライドのフォントサイズ

`create_from_template.py` で自動設定される推奨フォントサイズ：

| 要素         | サイズ  | 色               | 備考                   |
| ------------ | ------- | ---------------- | ---------------------- |
| タイトル     | 44-54pt | テーマ色         | プレースホルダー既定値 |
| サブタイトル | 24pt    | グレー (#646464) | 18pt → 24pt に改善済み |

> 💡 サブタイトルは読みやすさを考慮して 24pt に設定されています。

### セクションスライドのタイトル/サブタイトル位置

`create_from_template.py` は**動的に位置を調整**します（固定値ではない）：

| 状況                                      | 対処                               |
| ----------------------------------------- | ---------------------------------- |
| テンプレートの位置が正常（20%-60%範囲内） | 元の位置を維持                     |
| タイトルが範囲外（上すぎ/下すぎ）         | 40% に自動調整                     |
| タイトルとサブタイトルが重なる            | サブタイトルをタイトル下に自動移動 |

> 💡 テンプレートの設計を尊重しつつ、問題がある場合のみ自動調整されます。

## スライドマスター使い分けルール（★ 重要）

**問題**: 全スライドに同じレイアウトを使うと「素人っぽい」印象になる

**ルール**: スライドタイプに応じた適切なレイアウトを選択する

| スライドタイプ | 推奨レイアウト名                         | 説明                   |
| -------------- | ---------------------------------------- | ---------------------- |
| `title`        | Title / Title Slide / Title square photo | タイトル専用レイアウト |
| `section`      | Section Header / Section Divider         | セクション区切り       |
| `content`      | Title and Content / タイトルとコンテンツ | 標準コンテンツ         |
| `two_column`   | Two Content / 2 つのコンテンツ           | 比較・対照             |
| `closing`      | Closing / Thank You / Closing logo slide | エンディング専用       |
| `agenda`       | Title and Content                        | コンテンツと同じで OK  |

**自動対応**: `create_from_template.py` の `layout_mapping` で設定済みの場合は自動選択される。

**確認方法**:

```powershell
python scripts/analyze_template.py $template
# → layouts.json の layout_mapping を確認
```

## 🚨 スピーカーノートの充実（★ 自動検出対応）

**問題**: ノートが「出典: 元スライド #XX」だけだと、プレゼンターが何を話すべきか分からない

**自動検出**: `validate_pptx.py` が「出典のみ」パターンを検出して警告

```
⚠️ [source_only_notes] slides [14, 17, ...]: X slides have only source citations
💡 Add talking points, background info, or context for the presenter
```

**ルール**: 全スライドのノートには具体的な説明を含める

| スライドタイプ  | ノートに含めるべき内容                                 | 最低行数 |
| --------------- | ------------------------------------------------------ | -------- |
| **title**       | 自己紹介、セッションの目的                             | 3 行     |
| **agenda**      | アジェンダの概要、所要時間の目安                       | 2 行     |
| **section**     | セクションの目的、扱うトピックの概要、トランジション文 | 3-5 行   |
| **content**     | 各項目の詳細説明、背景情報、話し方のヒント             | 5-10 行  |
| **photo/image** | 画像の説明、何を見せているか、注目ポイント             | 3-5 行   |
| **two_column**  | 比較のポイント、結論として伝えたいこと                 | 3-5 行   |
| **summary**     | まとめのポイント、次のアクション                       | 3 行     |

### 良い例（section）

```json
{
  "type": "section",
  "title": "Microsoft Fabric のセキュリティ",
  "subtitle": "Fabric Copilot の保護",
  "notes": "ここからは Microsoft Fabric のデータセキュリティについて説明します。\n\nM365 と同様に、Fabric でも過剰共有は現実の問題です。同様のプレイブック（DSPM → DLP → 保護ポリシー）を適用できます。\n\n主なトピック:\n- DSPM の Fabric リスク評価\n- Fabric 向け DLP ポリシー\n- Fabric Copilot でのブロック\n\n---\n[出典: 元スライド #126-153 を基に要約]"
}
```

### 避けるべき例

```json
{
  "type": "section",
  "title": "Microsoft Fabric のセキュリティ",
  "subtitle": "Fabric Copilot の保護",
  "notes": "[出典: 元スライド #126-153 を基に要約]"
}
```

## 空スライドの除外

**以下のスライドは除外する:**

- スピーカーノートのみで本文・タイトルがないスライド
- 背景だけのスライド（デモ用スクリーンショット等）
- タイトルも箇条書きもないスライド

→ `reconstruct_analyzer.py` は自動検出して `type: "_empty"` とマークする

## オーバーフロー対策

1. **自動検証**: `validate_pptx.py` が BUILD 後にオーバーフローを自動検出（800 文字超、15 段落超、120 文字超の行）
2. **文字数制限**: タイトル 40 文字以内、箇条書き項目 80 文字以内を目安
3. **項目数制限**: 1 スライドあたり箇条書き 5-8 項目まで、内容に応じて 1 段落下げてもよい
4. **分割推奨**: 内容が多い場合はスライドを分割

## 画像サイズ適正化

| 元画像サイズ     | 推奨 width_percent | 備考         |
| ---------------- | ------------------ | ------------ |
| 大（1000px+）    | 40-50%             | 通常サイズ   |
| 中（500-1000px） | 30-40%             | やや小さめ   |
| 小（500px 未満） | 20-30%             | 拡大しない   |
| アイコン/ロゴ    | 15-25%             | 元サイズ維持 |

**重要**: 小さい画像を無駄に大きくしない（ぼやける）

### 🚨 タイトルスライドの画像サイズ制限（★ 重要）

タイトルスライド（`type: "title"` / `type: "closing"`）に画像を配置する場合、**最大 25% に自動制限**される。

**理由**:

- プレゼンター写真が大きすぎると、タイトルが途中で切れる
- タイトルスライドは「タイトル」が主役、画像は補助

**自動制限** (create_pptx.js / create_ja_pptx.py):

```json
// content.json で 45% を指定しても、title タイプでは 25% に制限される
{
  "type": "title",
  "title": "Microsoft Purview によるデータセキュリティ",
  "image": { "path": "images/presenter.jpg", "width_percent": 45 }
}
// → 実際は 25% で配置される
```

### 🚨 pptxgenjs でのアスペクト比維持（★ 重要）

`create_pptx.js` (B 方式) では、画像のアスペクト比を維持するために `sizing` オプションを使用：

```javascript
// ❌ NG: w のみ指定 → 画像が潰れる
slide.addImage({ x, y, w: imgW });

// ✅ OK: sizing: 'contain' でアスペクト比維持
slide.addImage({ x, y, sizing: { type: "contain", w: imgW, h: maxImgH } });
```

### 🚨 アイコン/ロゴの自動検出（★ 全方式対応済み）

以下の条件でアイコン/ロゴを自動検出し、サイズを制限：

| 条件                               | 判定     | 自動サイズ |
| ---------------------------------- | -------- | ---------- |
| 幅または高さ < 400px               | アイコン | 10-20%     |
| 正方形（0.9-1.1 比率）かつ ≤ 800px | ロゴ     | 15-25%     |
| 幅 > 高さ × 3（極端な横長）        | バナー   | 20%        |

**対応スクリプト**:

- `create_from_template.py` ✅
- `create_pptx.js` ✅
- `create_ja_pptx.py` ✅

**自動保護機能**:

- `create_from_template.py` は PIL で画像サイズを検出し、自然サイズの 150% を上限に自動制限
- ログに "(capped from X% to Y%)" と表示される場合は width_percent が制限された
- **高さ方向も自動制限**: `position: "center"` 時、画像高さがスライドをはみ出す場合は自動で縮小

## 🚨 center 配置での画像はみ出し防止（★ 重要）

`position: "center"` で縦長画像を配置すると、スライド下部にはみ出す可能性がある。

**自動対応（create_from_template.py）:**

- 画像高さがスライド利用可能領域の 95% を超える場合、高さ基準でリサイズ
- ログに "Image height limited" と表示される

**手動対応（content.json 作成時）:**

- 縦長画像は `width_percent: 50-60` 程度に抑える
- または `type: "content"` + `position: "right"` で横配置にする

```json
// ✅ 推奨: 縦長画像は width_percent を控えめに
{
  "type": "photo",
  "title": "Copilotロゴ",
  "image": {
    "path": "images/copilot_logo.png",
    "position": "center",
    "width_percent": 50
  }
}
```

## アイコン/ロゴの自動サイズ調整

以下の画像はアイコン/ロゴとして検出され、**適切な小さいサイズで配置**:

| 条件                                  | 推奨サイズ |
| ------------------------------------- | ---------- |
| 400px 未満（幅または高さ）            | 10-20%     |
| 正方形（0.9-1.1 比率）かつ 800px 以下 | 15-25%     |

## 🚨 content + image スライドのレイアウト（★ 重要）

`type: "content"` + `image` のスライドでは、**Two Column レイアウトを使用**して画像とテキストの重なりを防ぐ。

### 問題

| 状況                         | 症状                           |
| ---------------------------- | ------------------------------ |
| Title and Content レイアウト | 画像がテキストと重なる         |
| `content_with_image` 未設定  | 自動で適切なレイアウト選択不可 |
| テンプレート未クリーニング   | 背景画像が重なって表示される   |

### 解決策

1. **layouts.json に `content_with_image` を追加**:

```json
{
  "layout_mapping": {
    "content": 3,
    "content_with_image": 6,  // ★ Two Column レイアウト
    ...
  }
}
```

2. **テンプレートをクリーニング**:

```powershell
python scripts/diagnose_template.py $template
python scripts/clean_template.py $template "output_manifest/${base}_clean_template.pptx"
```

3. **スクリプトの自動選択**:

`create_from_template.py` は `type: "content"` + `image` を検出すると自動で `content_with_image` レイアウトを選択する。

### 推奨形式

```json
{
  "type": "content",
  "title": "M365 Copilotのセキュリティ",
  "items": ["グラウンディングデータの保護", "プロンプト/応答のDLP適用"],
  "image": {
    "path": "images/slide_14.png",
    "position": "right",
    "width_percent": 45
  }
}
```

## スクリーンショットスライドのルール

**コンテンツ（箇条書き）がないスライドでは画像を大きく表示:**

| スライドの内容               | 画像サイズ        | 説明の配置           |
| ---------------------------- | ----------------- | -------------------- |
| タイトル + 箇条書きあり      | 30-45% (右配置)   | 本文に記載           |
| タイトルのみ（箇条書きなし） | 60-80% (中央寄り) | **ノートに詳細記載** |
| 画像のみ（デモ画面等）       | 80-100% (フル)    | **ノートに詳細記載** |

### ⚠️ photo タイプの注意点（★ 重要）

**問題**: `type: "photo"` で画像だけのスライドを作ると「何を見せているかわからない」

**推奨**: photo タイプは **content タイプに変換**し、ノートから抽出した説明を追加

```json
// ❌ NG: 画像だけで何を見せているかわからない
{
  "type": "photo",
  "title": "DSPM ダッシュボード",
  "image": { "path": "images/slide_22.png", "position": "right", "width_percent": 45 }
}

// ✅ OK: 説明文を追加してわかりやすく
{
  "type": "content",
  "title": "DSPM ダッシュボード",
  "items": [
    "データセキュリティの簡素化",
    "主要なポスチャメトリクス",
    "目標（Objectives）の設定"
  ],
  "image": { "path": "images/slide_22.png", "position": "right", "width_percent": 50 }
}
```

**レイアウトの選択:**

| パターン                   | 推奨レイアウト         | 画像配置             |
| -------------------------- | ---------------------- | -------------------- |
| 説明文 + 画像              | Layout 3 (Content)     | `position: "right"`  |
| 画像中心（説明は最小限）   | Layout 12 (Title Only) | `position: "center"` |
| 画像のみ（フルスクリーン） | Layout 44 (Blank)      | `position: "full"`   |

**ポイント:**

- 短いタイトル（1 文）+ 大きな画像 + 詳細なノート
- 箇条書きを無理に入れない
- 画面操作の説明はノートに書く

## テンプレート選定

> 💡 `templates/` フォルダ内の `.pptx` ファイルを動的に取得して使用

| 用途               | 推奨テンプレート              | 備考                   |
| ------------------ | ----------------------------- | ---------------------- |
| 一般的なプレゼン   | `templates/` 内のテンプレート | 動的取得、先頭を推奨   |
| 元 PPTX の継承     | 元 PPTX 自体                  | reconstruct 方式で使用 |
| コード多め         | pptxgenjs で生成              | コードブロック対応     |
| シンプル・モノクロ | create_ja_pptx                | 最小限のスタイル       |

## スライド枚数計算ロジック

```
基本枚数 = タイトル(1) + アジェンダ(1) + コンテンツ + まとめ(1)
画像枚数 = 取得した主要画像の数
─────────────────────────────────
合計枚数 = 基本枚数 + 画像枚数
```

| ソース種別               | 画像なし目安 | 画像あり目安 | 目安の根拠        |
| ------------------------ | ------------ | ------------ | ----------------- |
| 短い記事（〜1500 字）    | 6-8 枚       | 10-14 枚     | 300 字/スライド   |
| 中程度（1500-4000 字）   | 10-14 枚     | 15-20 枚     | 手順数 ×1.5       |
| 長い技術記事（4000 字+） | 14-18 枚     | 20-30 枚     | セクション数 ×3-4 |
| 英語版 PPTX              | 元と同数     | 元と同数     | 1 対 1 マッピング |

**重要**: 画像が記事に含まれている場合、コンテンツスライドを減らすのではなく、**画像スライドを追加**する。
