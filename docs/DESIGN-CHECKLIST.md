# エージェントワークフロー設計チェックリスト

新規設計・修正時に確認すべき項目。

> 📅 最終更新: 2024-12-14

---

## 1. I/O 契約

- [ ] 入力スキーマが明確に定義されているか
- [ ] 出力スキーマが明確に定義されているか
- [ ] ディレクトリ構造が文書化されているか
- [ ] ファイル命名規則が統一されているか
- [ ] 中間生成物と最終成果物が分離されているか

## 2. 選択肢・ユーザー入力

- [ ] 選択肢は連続した ID（A, B, C...）で表現されているか
- [ ] 動的要素（テンプレート数）と固定要素の境界が明記されているか
- [ ] 入力フォーマット（例: `{枚数}{方式}`）が文書化されているか
- [ ] 具体例が十分に示されているか
- [ ] デフォルト動作が定義されているか

## 3. エージェント責務

- [ ] 各エージェントが単一責務になっているか
- [ ] Agent vs Script の判断基準が明確か
  - AI 判断が必要 → Agent
  - 決定論的 → Script
- [ ] Orchestrator は状態管理のみに専念しているか
- [ ] Worker Agent は入出力が明確か

## 4. ワークフロー

- [ ] フェーズ遷移図が最新か
- [ ] 各フェーズの担当が明確か
- [ ] 並列実行可能なフェーズが特定されているか
- [ ] 依存関係が文書化されているか

## 5. エラー処理

- [ ] リトライ回数が定義されているか
- [ ] エスカレーション条件が明確か
- [ ] エスカレーション時の出力形式が定義されているか
- [ ] 再開コマンドが提供されているか

## 6. 検証

- [ ] スキーマ検証が実装されているか
- [ ] 空コンテンツ検出があるか
- [ ] キーワード検出（type 以外）も考慮されているか
- [ ] 出力形式（PASS/WARN/FAIL）が統一されているか

## 7. ドキュメント

- [ ] SSOT の原則が守られているか（1 箇所で定義、他は参照）
- [ ] TROUBLESHOOTING.md に新しい問題が追記されているか
- [ ] 具体例が十分か
- [ ] 変更履歴が記録されているか

## 8. スクリプト

- [ ] 型ヒントがあるか（Python）
- [ ] docstring があるか
- [ ] エラーハンドリングが適切か
- [ ] 冪等性が確保されているか

---

## 9. 入力ソース分析 ★ 新規

- [ ] **構成要素の列挙**: テキスト、画像、コードブロック、メタデータを明示的にリストアップしたか？
- [ ] **取得ツールの制限確認**: `fetch_webpage` は画像 URL を返さない場合がある → `curl` で補完が必要か？
- [ ] **コードブロックの有無**: 技術記事の場合、`<pre><code>` タグの存在を確認したか？
- [ ] **画像 URL の抽出方法**: 正規表現パターンを定義したか？

## 10. テンプレート・出力形式 ★ 新規

- [ ] **スライドサイズの確認**: 標準（13.333×7.5）以外のテンプレートを使用するか？
- [ ] **動的サイズ取得**: `prs.slide_width.inches` / `prs.slide_height.inches` を使用しているか？
- [ ] **ハードコード値の排除**: 画像配置、コードブロック位置に固定値がないか？
- [ ] **比率計算**: 位置・サイズをスライドサイズに対する比率（%）で計算しているか？

## 11. IR スキーマと実装の同期 ★ 新規

- [ ] **新規フィールドの追加**: スキーマ (`content.schema.json`) に定義したか？
- [ ] **実装との同期**: スキーマに定義したフィールドが全スクリプトで処理されるか？
- [ ] **必須/オプションの明確化**: `required` 配列を更新したか？

## 12. テスト・検証 ★ 新規

- [ ] **異なるサイズのテンプレート**: 標準以外のテンプレートでテストしたか？
- [ ] **画像あり/なし両方**: 画像を含むスライドと含まないスライドを両方テストしたか？
- [ ] **コードブロックあり/なし**: コードブロックの有無でテストしたか？
- [ ] **複数方式でのテスト**: C/D/E など複数の生成方式でテストしたか？

---

## クイックチェック（最低限）

設計・修正時に必ず確認：

- [ ] **連続 ID**: 選択肢が A, B, C...で連続しているか
- [ ] **入力フォーマット例**: `2A`, `3C` のような例があるか
- [ ] **スキーマ検証**: validate スクリプトがキーワードも検出するか
- [ ] **SSOT**: ルールが 1 箇所で定義されているか
- [ ] **TROUBLESHOOTING**: 新しい問題を追記したか
- [ ] **ハードコード排除**: 固定値（13.333, 7.5, 4.5 等）がないか ★ 新規
- [ ] **構成要素の完全抽出**: 画像・コードが漏れていないか ★ 新規

---

## よくある落とし穴 ★ 新規

### ハードコード値の例

```python
# ❌ NG
slide_width = 13.333
code_top = Inches(4.5)

# ✅ OK
slide_width = prs.slide_width.inches
code_top = Inches(slide_height * 0.6)
```

### ツール制限の例

| ツール          | 制限                          | 代替手段          |
| --------------- | ----------------------------- | ----------------- |
| `fetch_webpage` | 画像 URL を返さない場合がある | `curl` + 正規表現 |

### スキーマ vs 実装の乖離

```json
// スキーマに定義
{ "code": { "type": "string" } }
```

```python
# 実装で処理されていない → 何も起きない
def add_slide(...):  # code パラメータなし
    pass
```

---

## 参照

- [WORKFLOW-DESIGN-GUIDE.md](WORKFLOW-DESIGN-GUIDE.md) - 汎用設計ガイド
- [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - 問題と対策
